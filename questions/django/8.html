<h6 class="card-title question-pre">
Django: create a complete sample connecting users and employees. 
# installations


# settings


# core/urls.py


# users/urls.py
# none


# employees/urls.py


# users/models.py
# none


# employees/models.py


# users/forms.py


# employees/forms.py


# employees/utils.py


# core/templates/base.html


# pages/templates/pages/about.html


# users/templates/users/login.html


# users/templates/users/password_reset_complete.html


# users/templates/users/password_reset_confirm.html


# users/templates/users/password_reset_done.html


# users/templates/users/password_reset_form.html


# users/templates/users/profile.html


# users/templates/users/profile_update.html


# users/templates/users/register.html


# employees/static/js/employee_list.js


# employees/templates/employees/employee_form.html


# employees/templates/employees/employee_list.html


# employees/templates/employees/employee_detail.html


# employees/templates/registration/login.html


# employees/templates/registration/logged_out.html


# pages/views.py


# users/views.py


# employees/views.py


# employees/admin.py


# employees/signals.py


# employees/tasks.py


# core/core/celery.py


# core/core/static/js/main.js


# core/management_commands/management/commands/insert_seeds.py


# core/management_commands/management/commands/seed_employees_employee.py


# core/management_commands/management/commands/seed_employees_employeejob.py


# core/management_commands/management/commands/seed_employees_employeejoblevel.py


# core/management_commands/management/commands/seed_employees_employeejobspecialty.py


# core/management_commands/management/commands/seed_employees_employeestatus.py


</h6>
<p class="card-text answer-pre">
# installations
> python -m venv env
> env\Scripts\activate
> pip install Django
> django-admin startproject core
> cd core
> code .
> python manage.py startapp pages
> python manage.py startapp users
> python manage.py startapp employees
> pip install crispy-bootstrap5
> pip install celery
> pip install django-celery-results
> pip install pandas
> pip install flower
> pip install gunicorn
> pip install openpyxl
> pip install numpy
> python manage.py makemigrations
> python manage.py migrate
> python manage.py runserver



# settings
import os
import sys
from pathlib import Path
from decouple import config
from celery import Celery
DOCKER_ENV = config('DOCKER_ENV', default=False, cast=bool)
INSTALLED_APPS = [
    'core',
    'management_commands',
    'pages',
    'users',
    'employees',
    'django_celery_results',
    ...
]
if DEBUG:
    INSTALLED_APPS += ['debug_toolbar']
MIDDLEWARE = [
]
if DEBUG:
    MIDDLEWARE += ['debug_toolbar.middleware.DebugToolbarMiddleware']
TEMPLATES = [
    {
        'DIRS': [
            BASE_DIR / 'templates'
        ],
        ...
    },
]
if DOCKER_ENV:
    CELERY_BROKER_URL = config('CELERY_BROKER_URL', default='amqp://guest:guest@rabbitmq:5672//')
    CELERY_ACCEPT_CONTENT = ['json']
    CELERY_TASK_SERIALIZER = 'json'
    CELERY_RESULT_SERIALIZER = 'json'
else:
    CELERY_BROKER_URL = 'amqp://localhost'
CELERY_RESULT_BACKEND = 'django-db'
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'static')
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
CRISPY_ALLOWED_TEMPLATE_PACKS = "bootstrap5"
CRISPY_TEMPLATE_PACK = "bootstrap5"
LOGIN_REDIRECT_URL = 'profile'
LOGOUT_REDIRECT_URL = 'login'
LOGIN_URL = 'login'
DEBUG_TOOLBAR_CONFIG = {
    'SHOW_TOOLBAR_CALLBACK': lambda request: True,
    'ENABLE_STACKTRACES': True,
    'INTERCEPT_REDIRECTS': False,
}
# default is 1k. Increased to 3k to cater viewing tables with 365 days columns for datatables
DATA_UPLOAD_MAX_NUMBER_FIELDS = 3000



# core/urls.py
from django.contrib import admin
from django.urls import path, include
from users import views as user_views
from django.conf import settings
from django.conf.urls.static import static
from django.contrib.auth import views as auth_views
from users.forms import CustomLoginForm
urlpatterns = [
    path('admin/', admin.site.urls),
    path('employees/', include('employees.urls')),
    path('profile/', user_views.profile, name='profile'),
    path('profile/password/', user_views.change_password, name='change_password'),
    path('accounts/login/', auth_views.LoginView.as_view(
        template_name='registration/login.html',
        authentication_form=CustomLoginForm),
        name='login'),
    # Include Django auth URLs for login/logout
    path('accounts/', include('django.contrib.auth.urls')),
    path('', include('pages.urls')),
]
if settings.DEBUG:
    import debug_toolbar
    urlpatterns = [
        path('__debug__/', include(debug_toolbar.urls)),
    ] + urlpatterns
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)



# users/urls.py
# none



# employees/urls.py
from django.urls import path
from employees.views import EmployeeListView, EmployeeCreateView, EmployeeDetailView, EmployeeUpdateView, ajx_employee_list, ajx_export_excel_all_employees, ajx_export_excel_filtered_employees, ajx_import_insert_excel_employees_celery, ajx_import_update_excel_employees_celery, ajx_tasks_status
app_name = 'employees'
urlpatterns = [
    path('create/', EmployeeCreateView.as_view(), name='employee-create'),
    path('<int:pk>/', EmployeeDetailView.as_view(), name='employee-detail'),
    path('<int:pk>/update/', EmployeeUpdateView.as_view(), name='employee-update'),
    # path('<int:pk>/delete/', EmployeeDeleteView.as_view(), name='employee-delete'),
    path('ajx_employee_list/', ajx_employee_list, name='ajx_employee_list'), 
    path('ajx_export_excel_all_employees/', ajx_export_excel_all_employees, name='ajx_export_excel_all_employees'),
    path('ajx_export_excel_filtered_employees/', ajx_export_excel_filtered_employees, name='ajx_export_excel_filtered_employees'),
    path('ajx_import_insert_excel_employees_celery', ajx_import_insert_excel_employees_celery, name='ajx_import_insert_excel_employees_celery'),
    path('ajx_import_update_excel_employees_celery', ajx_import_update_excel_employees_celery, name='ajx_import_update_excel_employees_celery'),
    path('ajx_tasks_status/<str:task_id>', ajx_tasks_status, name='ajx_tasks_status'),
    path('', EmployeeListView.as_view(), name='employee-list'),
]



# users/models.py
# none



# employees/models.py
from django.db import models
from django.contrib.auth.models import User
from django.core.exceptions import ValidationError
from django.utils import timezone
from datetime import timedelta
def validate_age(value):
    today = timezone.now().date()
    age_limit = today - timedelta(days=18*365.25)
    if value > age_limit:
        raise ValidationError('Employee must be at least 18 years old.')
class EmployeeStatus(models.Model):
    name = models.CharField(max_length=50, unique=True)
    def __str__(self):
        return self.name
class EmployeeJob(models.Model):
    name = models.CharField(max_length=100, unique=True)
    def __str__(self):
        return self.name
class EmployeeJobLevel(models.Model):
    name = models.CharField(max_length=100, unique=True)
    def __str__(self):
        return self.name
class EmployeeJobSpecialty(models.Model):
    name = models.CharField(max_length=100, unique=True)
    def __str__(self):
        return self.name
class Employee(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    company_id = models.CharField(max_length=50, unique=True)
    contact = models.CharField(max_length=100)
    middle_name = models.CharField(max_length=100, blank=True)
    gender = models.CharField(max_length=10, choices=[('MALE', 'MALE'), ('FEMALE', 'FEMALE')])
    birth_date = models.DateField(validators=[validate_age], blank=True, null=True)
    address = models.CharField(max_length=255, blank=True, null=True)
    status = models.ForeignKey(EmployeeStatus, on_delete=models.SET_NULL, null=True)
    start_date = models.DateField(blank=True, null=True)
    regular_date = models.DateField(blank=True, null=True)
    separation_date = models.DateField(blank=True, null=True)
    position = models.ForeignKey(EmployeeJob, on_delete=models.SET_NULL, null=True)
    position_level = models.ForeignKey(EmployeeJobLevel, on_delete=models.SET_NULL, null=True)
    position_specialties = models.ManyToManyField(EmployeeJobSpecialty, blank=True)
    def __str__(self):
        return self.company_id



# users/forms.py
from django import forms
from django.contrib.auth.models import User
from django.contrib.auth.forms import UserChangeForm, PasswordChangeForm, AuthenticationForm
class UserUpdateForm(forms.ModelForm):
    email = forms.EmailField(help_text='Enter a valid email address.')
    class Meta:
        model = User
        fields = ['username', 'email']
    def clean_email(self):
        email = self.cleaned_data.get('email')
        if User.objects.filter(email=email).exclude(username=self.instance.username).exists():
            raise forms.ValidationError('This email address is already in use.')
        return email
    def clean_username(self):
        username = self.cleaned_data.get('username')
        if User.objects.filter(username=username).exclude(pk=self.instance.pk).exists():
            raise forms.ValidationError('This username is already taken.')
        return username
class PasswordChangingForm(PasswordChangeForm):
    old_password = forms.CharField(widget=forms.PasswordInput(attrs={'class': 'form-control', 'type': 'password'}))
    new_password1 = forms.CharField(widget=forms.PasswordInput(attrs={'class': 'form-control', 'type': 'password'}))
    new_password2 = forms.CharField(widget=forms.PasswordInput(attrs={'class': 'form-control', 'type': 'password'}))
    class Meta:
        model = User
        fields = ['old_password', 'new_password1', 'new_password2']
class CustomLoginForm(AuthenticationForm):
    username = forms.CharField(
        label="Username or Company ID",
        widget=forms.TextInput(attrs={'class': 'form-control'})
    )
    password = forms.CharField(
        label="Password",
        widget=forms.PasswordInput(attrs={'class': 'form-control', 'type': 'password'})
    )



# employees/forms.py
from django import forms
from django.contrib.auth.models import User, Group, Permission
from django.core.exceptions import ValidationError
from employees.models import Employee, EmployeeJob, EmployeeJobLevel, EmployeeJobSpecialty, EmployeeStatus
from employees.utils import generate_username
class EmployeeCreationForm(forms.ModelForm):
    birth_date = forms.DateField(widget=forms.DateInput(attrs={'type': 'date'}), required=True)
    start_date = forms.DateField(widget=forms.DateInput(attrs={'type': 'date'}), required=True)
    password1 = forms.CharField(widget=forms.PasswordInput())
    password2 = forms.CharField(widget=forms.PasswordInput())
    first_name = forms.CharField(max_length=100, required=True)
    last_name = forms.CharField(max_length=100, required=True)
    gender = forms.ChoiceField(choices=[('MALE', 'MALE'), ('FEMALE', 'FEMALE')])
    email = forms.EmailField(required=True)
    class Meta:
        model = Employee
        fields = [
            'company_id',
            'email',
            'first_name',
            'last_name',
            'middle_name',
            'gender',
            'contact',
            'birth_date',
            'address',
            'start_date',
            'status',
            'position',
            'position_level',
            'position_specialties',
            'password1',
            'password2',
        ]
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.fields['password1'].initial = 'welcome01'
        self.fields['password2'].initial = 'welcome01'
        self.fields['password1'].widget.attrs['value'] = 'welcome01'
        self.fields['password2'].widget.attrs['value'] = 'welcome01'
        self.fields['password1'].widget = forms.HiddenInput()
        self.fields['password2'].widget = forms.HiddenInput()
    def clean_password1(self):
        return 'welcome01'
    def clean_password2(self):
        return 'welcome01'
    def clean_username(self):
        username = self.cleaned_data.get('username')
        if User.objects.filter(username=username).exists():
            raise ValidationError("A user with that username already exists.")
        return username
    def clean_email(self):
        email = self.cleaned_data.get('email')
        if User.objects.filter(email=email).exists():
            raise ValidationError("A user with that email already exists.")
        return email
    def clean(self):
        cleaned_data = super().clean()
        password1 = cleaned_data.get('password1')
        password2 = cleaned_data.get('password2')
        start_date = cleaned_data.get('start_date')
        regular_date = cleaned_data.get('regular_date')
        if (password1 and password2) and (password1 != password2):
            raise forms.ValidationError("Passwords do not match.")
        if not start_date:
            raise ValidationError({'start_date': 'Start date is required.'})
        if (regular_date and start_date) and (regular_date < start_date):
            raise ValidationError({'regular_date': 'Regular date cannot be earlier than start date.'})
        return cleaned_data
    def clean_company_id(self):
        return self.cleaned_data['company_id'].upper()
    def save(self, commit=True):
        first_name = self.cleaned_data.get('first_name')
        last_name = self.cleaned_data.get('last_name')
        username = generate_username(first_name)
        email = self.cleaned_data.get('email')
        user = User(
            username=username,
            email=email,
            first_name=first_name,
            last_name=last_name
        )
        user.set_password(self.cleaned_data['password1'])
        if commit:
            user.save()
        employee = super().save(commit=False)
        employee.user = user
        if commit:
            employee.save()
            self.save_m2m()
        return employee
class EmployeeUpdateForm(forms.ModelForm):
    birth_date = forms.DateField(widget=forms.DateInput(attrs={'type': 'date'}), required=True)
    start_date = forms.DateField(widget=forms.DateInput(attrs={'type': 'date'}), required=True)
    first_name = forms.CharField(max_length=100, required=True)
    last_name = forms.CharField(max_length=100, required=True)
    gender = forms.ChoiceField(choices=[('MALE', 'MALE'), ('FEMALE', 'FEMALE')])
    email = forms.EmailField(required=True)
    username = forms.CharField(max_length=150)
    class Meta:
        model = Employee
        fields = [
            'company_id',
            'username',
            'email',
            'first_name',
            'last_name',
            'middle_name',
            'gender',
            'contact',
            'birth_date',
            'address',
            'start_date',
            'status',
            'position',
            'position_level',
            'position_specialties',
        ]
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        if self.instance and self.instance.user:
            self.fields['email'].initial = self.instance.user.email
            self.fields['first_name'].initial = self.instance.user.first_name
            self.fields['last_name'].initial = self.instance.user.last_name
            self.fields['username'].initial = self.instance.user.username
    def clean_username(self):
        username = self.cleaned_data.get('username')
        if User.objects.filter(username=username).exclude(pk=self.instance.user.pk).exists():
            raise ValidationError("A user with that username already exists.")
        return username
    def clean_email(self):
        email = self.cleaned_data.get('email')
        if email:
            if User.objects.filter(email=email).exclude(pk=self.instance.user.pk).exists():
                raise ValidationError("A user with that email already exists.")
        return email
    def clean(self):
        cleaned_data = super().clean()
        start_date = cleaned_data.get('start_date')
        regular_date = cleaned_data.get('regular_date')
        if not start_date:
            raise ValidationError({'start_date': 'Start date is required.'})
        if (regular_date and start_date) and (regular_date < start_date):
            raise ValidationError({'regular_date': 'Regular date cannot be earlier than start date.'})
        return cleaned_data
    def clean_company_id(self):
        return self.cleaned_data['company_id'].upper()
    def save(self, commit=True):
        employee = super().save(commit=False)
        user = employee.user
        user.username = self.cleaned_data['username']
        user.email = self.cleaned_data['email']
        user.first_name = self.cleaned_data['first_name']
        user.last_name = self.cleaned_data['last_name']
        if commit:
            user.save()
            employee.save()
            self.save_m2m()
        return employee
class EmployeeExcelUploadForm(forms.Form):
    file = forms.FileField()



# employees/utils.py
import random
import string
import os
import pandas as pd
import datetime
from django.conf import settings
from django.utils.regex_helper import _lazy_re_compile
from django.db import transaction
from django.db.models import Q
from django.core.exceptions import ObjectDoesNotExist
from django.core.management.base import CommandError
from django.contrib.auth.hashers import make_password
from django.contrib.auth.models import User
from employees.models import Employee, EmployeeJob, EmployeeJobLevel, EmployeeJobSpecialty, EmployeeStatus
date_re = _lazy_re_compile(
    r"(?P<year>\d{4})-(?P<month>\d{1,2})-(?P<day>\d{1,2})$")
def generate_username(name):
    first_word = name.split()[0].lower().replace(",", "")
    random_digits = ''.join(random.choices(string.digits, k=5))
    return f"{first_word}_{random_digits}"
def get_existing_names_case_insensitive(model, field_name, values):
    """
    Perform a case-insensitive filter on the given model's field for the provided list of values.
    Returns a list of matching values that exist in the database.
    """
    query = Q()
    for value in values:
        query |= Q(**{f"{field_name}__iexact": value})
    return model.objects.filter(query).values_list(field_name, flat=True)
def should_be(mode, model, model_name, field_name, column_records):
    records_results = get_existing_names_case_insensitive(model, field_name, column_records)
    if mode.upper() == 'NOT EXISTING':
        # eg. use for checking if values are already existing so we can safely insert new records
        if records_results:
            raise CommandError(f"The following {model_name}.{field_name} values already exist: {', '.join(records_results)}")
    elif mode.upper() == 'EXISTING':
        # eg. use for checking if values are existing for updating records. Can also be used for checking if foreign key values do exist
        missing_records = set(column_records) - {name.upper() for name in records_results}
        if missing_records:
            raise CommandError(f"The following {model_name}.{field_name} values do not exist: {', '.join(missing_records)}")
def parse_date(date_str):
    if pd.isna(date_str):
        return None
    try:
        return datetime.date.fromisoformat(date_str)
    except ValueError:
        if match := date_re.match(date_str):
            kw = {k: int(v) for k, v in match.groupdict().items()}
            return datetime.date(**kw)
def load_foreign_keys():
    # just creating dictionaries here for easy access of values later
    statuses = {s.name.upper(): s for s in EmployeeStatus.objects.all()}
    positions = {p.name.upper(): p for p in EmployeeJob.objects.all()}
    levels = {l.name.upper(): l for l in EmployeeJobLevel.objects.all()}
    specialties = {s.name.upper(): s for s in EmployeeJobSpecialty.objects.all()}
    return {
        'statuses': statuses,
        'positions': positions,
        'levels': levels,
        'specialties': specialties,
    }
def verify_excel_employees(df, mode='INSERT'):
    required_columns = ['COMPANY ID', 'FIRST NAME', 'LAST NAME', 'GENDER', 'CONTACT', 'ADDRESS', 'BIRTH DATE', 'START DATE', 'STATUS', 'POSITION']
    # for column in required_columns:
    #     if column not in df.columns:
    #         raise CommandError(f"Missing required column: {column}")
    if not all(col in df.columns for col in required_columns):
        missing_columns = [col for col in required_columns if col not in df.columns]
        raise CommandError(f"Missing required columns: {', '.join(missing_columns)}")
    # print(df)
    df['COMPANY ID'] = df['COMPANY ID'].fillna(
        '').astype(str).str.strip().str.upper().replace(" ", "-", regex=True)
    df['FIRST NAME'] = df['FIRST NAME'].fillna('').str.strip()
    df['LAST NAME'] = df['LAST NAME'].fillna('').str.strip()
    df['GENDER'] = df['GENDER'].fillna('').str.strip().str.upper()
    df['CONTACT'] = df['CONTACT'].fillna('').astype(str).str.strip()
    df['ADDRESS'] = df['ADDRESS'].fillna('').str.strip()
    df['POSITION'] = df['POSITION'].fillna('').str.strip().str.upper()
    df['STATUS'] = df['STATUS'].fillna('').str.strip().str.upper()
    df['BIRTH DATE'] = pd.to_datetime(df['BIRTH DATE'], errors='coerce')
    df['BIRTH DATE'] = df['BIRTH DATE'].map(lambda x: x.strftime('%Y-%m-%d'))
    df['START DATE'] = pd.to_datetime(df['START DATE'], errors='coerce')
    df['START DATE'] = df['START DATE'].map(lambda x: x.strftime('%Y-%m-%d'))
    #
    if 'REGULAR DATE' in df.columns:
        df['REGULAR DATE'] = pd.to_datetime(
            df['REGULAR DATE'], errors='coerce')
        df['REGULAR DATE'] = df['REGULAR DATE'].map(
            lambda x: x.strftime('%Y-%m-%d') if pd.notna(x) else None)
    if 'SEPARATION DATE' in df.columns:
        df['SEPARATION DATE'] = pd.to_datetime(
            df['SEPARATION DATE'], errors='coerce')
        df['SEPARATION DATE'] = df['SEPARATION DATE'].map(
            lambda x: x.strftime('%Y-%m-%d') if pd.notna(x) else None)
    # Validate required columns should have values
    for col in required_columns:
        for _, row in df.iterrows():
            if row[col] == '':
                raise CommandError(f"Missing values in some {col} rows.")
    # check columns that should be unique
    columns_to_check = ['COMPANY ID']
    for column in columns_to_check:
        column_records = df[column].unique()
        field_name = 'name'
        if column == 'COMPANY ID':
            field_name = 'company_id'
    if mode == 'INSERT':
        should_be('NOT EXISTING', Employee, 'Employee',
                    field_name, column_records)
    elif mode == 'UPDATE':
        should_be('EXISTING', Employee, 'Employee', field_name, column_records)
    # Validate gender and boolean fields
    if not df['GENDER'].isin(['MALE', 'FEMALE']).all():
        raise CommandError("Invalid GENDER value. Must be 'MALE' or 'FEMALE'.")
    # a single blank value will auto convert every value to float. As of now, this is how we clean it.
    # df['IS LOCAL'] = df['IS LOCAL'].replace({'': 'TRUE'})
    # df['IS LOCAL'] = df['IS LOCAL'].replace({'1.0': 'TRUE'})
    # df['IS LOCAL'] = df['IS LOCAL'].replace({'0.0': 'FALSE'})
    # if not df['IS LOCAL'].isin(['TRUE', 'FALSE']).all():
    #     raise CommandError("Invalid IS LOCAL value. Must be 'TRUE' or 'FALSE'.")
    # Verify if values exists
    columns_to_check = ['STATUS', 'POSITION']
    for column in columns_to_check:
        column_records = df[column].unique()
        field_name = 'name'
        if column == 'STATUS':
            model = EmployeeStatus
            model_name = 'EmployeeStatus'
        elif column == 'POSITION':
            model = EmployeeJob
            model_name = 'EmployeeJob'
        should_be('EXISTING', model, model_name, field_name, column_records)
    # Verify value ONLY IF column is exisiting in file
    columns_to_check = ['POSITION SPECIALTIES']
    for column in columns_to_check:
        if column in df.columns:
            #
            df[column] = df[column].replace({None: ''})
            df[column] = df[column].fillna('')
            df[column] = df[column].str.strip().str.upper()
            df[column] = df[column].replace({'': None})
            #
            column_records = df[column].unique()
            column_records = column_records[~pd.isnull(column_records)]
            if not pd.isna(column_records).any():
                field_name = 'name'
                if column == 'POSITION SPECIALTIES':
                    model = EmployeeJobSpecialty
                    model_name = 'EmployeeJobSpecialty'
                    # employee can have multiple EmployeeJobSpecialty as to why we need to split it
                    split_records = []
                    for record in column_records:
                        # Split the record by comma and strip any whitespace
                        split_records.extend([r.strip() for r in record.split(',')])
                    # Remove duplicates and convert to a numpy array or list
                    column_records = pd.unique(split_records)
                should_be('EXISTING', model, model_name, field_name, column_records)
    return df
def insert_excel_employees(df):
    # First, verify and clean the input DataFrame
    df = verify_excel_employees(df, 'INSERT')
    # Load foreign key references
    foreign_keys = load_foreign_keys()
    # Insert new employees
    users = []
    employees = []
    default_password = make_password('welcome01')
    for _, row in df.iterrows():
        # Create User instance
        username = generate_username(row['FIRST NAME'])
        first_name = row['FIRST NAME']
        last_name = row['LAST NAME']
        user = User(username=username, password=default_password, first_name=first_name, last_name=last_name)
        if 'EMAIL' in df.columns and pd.notnull(row['EMAIL']):
            user.email = row['EMAIL']
        users.append(user)
        # Create Employee instance
        employee = Employee(
            user=user,
            company_id=row['COMPANY ID'],
            contact='' if pd.isna(row.get('CONTACT', None)) else row.get('CONTACT', None),
            middle_name='' if pd.isna(row.get('MIDDLE NAME', None)) else row.get('MIDDLE NAME', None),
            gender=row['GENDER'],
            address='' if pd.isna(row.get('ADDRESS', None)) else row.get('ADDRESS', None),
            birth_date=parse_date(row.get('BIRTH DATE')),
            start_date=parse_date(row.get('START DATE')),
            status=foreign_keys['statuses'].get(row['STATUS'].upper()),
            position=foreign_keys['positions'].get(row['POSITION'].upper()),
            position_level=None if pd.isna(foreign_keys['levels'].get(row['POSITION LEVEL'], None)) else foreign_keys['levels'].get(row['POSITION LEVEL'].upper(), None),
            regular_date=parse_date(row.get('REGULAR DATE')),
            separation_date=parse_date(row.get('SEPARATION DATE')),
        )
        employees.append(employee)
    with transaction.atomic():
        # Save users and employees
        User.objects.bulk_create(users)
        for i, employee in enumerate(employees):
            employee.user = users[i]
        Employee.objects.bulk_create(employees)
        # Add specialties to each employee after bulk creation
        for i, employee in enumerate(employees):
            # Get the corresponding row for this employee
            row = df.iloc[i]
            specialties = row.get('POSITION SPECIALTIES', '')
            if pd.notna(specialties):
                specialty_list = [specialty.strip() for specialty in specialties.split(',')]
                employee.position_specialties.add(*EmployeeJobSpecialty.objects.filter(name__in=specialty_list))
    return True
def update_excel_employees(df):
    # First, verify and clean the input DataFrame
    df = verify_excel_employees(df, 'UPDATE')
    # Load foreign key references
    foreign_keys = load_foreign_keys()
    # Prepare lists for bulk updates
    users_to_update = []
    employees_to_update = []
    try:
        with transaction.atomic():
            for _, row in df.iterrows():
                try:
                    # Fetch the existing Employee record by unique identifier
                    employee = Employee.objects.select_related('user').get(company_id=row['COMPANY ID'])
                    # Update User information if necessary
                    user = employee.user
                    if 'EMAIL' in df.columns and pd.notnull(row['EMAIL']):
                        user.email = row['EMAIL']
                    if 'FIRST NAME' in df.columns and pd.notnull(row['FIRST NAME']):
                        user.first_name = row['FIRST NAME']
                    if 'LAST NAME' in df.columns and pd.notnull(row['LAST NAME']):
                        user.last_name = row['LAST NAME']
                    users_to_update.append(user)
                    # Update Employee fields
                    employee.contact = '' if pd.isna(row.get('CONTACT', None)) else row.get('CONTACT', None)
                    employee.middle_name = '' if pd.isna(row.get('MIDDLE NAME', None)) else row.get('MIDDLE NAME', None)
                    employee.gender = row['GENDER']
                    employee.address = '' if pd.isna(row.get('ADDRESS', None)) else row.get('ADDRESS', None)
                    employee.birth_date = parse_date(row.get('BIRTH DATE'))
                    employee.start_date = parse_date(row.get('START DATE'))
                    employee.status = foreign_keys['statuses'].get(row['STATUS'].upper())
                    employee.position = foreign_keys['positions'].get(row['POSITION'].upper())
                    employee.position_level = None if pd.isna(foreign_keys['levels'].get(row['POSITION LEVEL'], None)) else foreign_keys['levels'].get(row['POSITION LEVEL'].upper(), None)
                    employee.regular_date = parse_date(row.get('REGULAR DATE'))
                    employee.separation_date = parse_date(row.get('SEPARATION DATE'))
                    employees_to_update.append(employee)
                except ObjectDoesNotExist:
                    # Handle the case where an employee does not exist, if needed
                    continue
            # Perform bulk update on Users and Employees
            # Add other fields as needed
            User.objects.bulk_update(users_to_update, [
                'email',
                'first_name',
                'last_name'
            ])
            Employee.objects.bulk_update(employees_to_update, [
                'contact',
                'middle_name',
                'gender',
                'address',
                'birth_date',
                'start_date',
                'status',
                'position',
                'position_level',
                'regular_date',
                'separation_date'
            ])
            # Update specialties for each employee
            for employee in employees_to_update:
                row = df[df['COMPANY ID'] == employee.company_id].iloc[0]
                specialties = row.get('POSITION SPECIALTIES', '')
                # Always clear existing specialties
                employee.position_specialties.clear()
                # If there are new specialties, add them
                if pd.notna(specialties) and specialties.strip() != '':
                    specialty_list = [specialty.strip() for specialty in specialties.split(',')]
                    employee.position_specialties.add(*EmployeeJobSpecialty.objects.filter(name__in=specialty_list))
        return True
    except Exception as e:
        print(f"Error during update: {e}")
        return False
def handle_uploaded_file(f):
    file_path = os.path.join(settings.MEDIA_ROOT, 'uploads', f.name)
    with open(file_path, 'wb+') as destination:
        for chunk in f.chunks():
            destination.write(chunk)
    return file_path



# core/templates/base.html
...



# pages/templates/pages/about.html


# users/templates/users/login.html


# users/templates/users/password_reset_complete.html


# users/templates/users/password_reset_confirm.html


# users/templates/users/password_reset_done.html


# users/templates/users/password_reset_form.html


# users/templates/users/profile.html


# users/templates/users/profile_update.html


# users/templates/users/register.html



# employees/static/js/employee_list.js
$(document).ready(function() {
    console.log('employee_list.js ready');
    localStorage.removeItem('importTaskId');
    var taskId = localStorage.getItem('importTaskId');
    if (taskId) {
        checkTaskStatus(taskId);
        disableControls();
        $('#loader').show();
        $("#message").addClass("alert alert-info");
        $('#message').text('still importing, please wait...');
        $('#message').show();
    }
    let table = $('#employeeTable').DataTable({
        processing: true,
        serverSide: true,
        scrollX: true,
        ajax: {
            url: "/employees/ajx_employee_list/",
            type: 'GET',
            data: function(d) {
                d.position = getCheckedValues('chkPosition');
                d.specialty = getCheckedValues('chkSpecialty');
                d.gender = getCheckedValues('chkGender');
                d.employee_status = getCheckedValues('chkEmployeeStatus');
            }
        },
        columns: [
            { data: 'company_id' },
            { data: 'start_date' },
            { data: 'last_name' },
            { data: 'first_name' },
            { data: 'middle_name' },
            { data: 'position' },
            { data: 'specialties' },
            { data: 'level' },
            { data: 'gender' },
            { data: 'status' },
        ],
        layout: {
            // topStart: 'pageLength',
            // topEnd: 'search',
            // bottomStart: 'info',
            // bottomEnd: 'paging'
            // top2Start: 'pageLength',
            topStart: 'search',
            top2End: 'info',
            topEnd: 'pageLength',
            bottomStart: 'paging',
            bottomEnd: 'info',
            // bottom2Start: 'info',
            // bottom2End: 'paging'
        },
        order: [[0, 'asc']],
        pageLength: 25,
    });
    $('input[type=checkbox][name=chkPosition], input[type=checkbox][name=chkSpecialty], input[type=checkbox][name=chkGender], input[type=checkbox][name=chkEmployeeStatus]').change(function() {
        let groupName = $(this).attr("name");
        // get the master checkbox for this group
        let groupAllCheckbox = $('#'+groupName+'-0');
        // 
        // get the other group checkbox that is not master 
        let otherCheckboxes = $('input[type=checkbox][name='+groupName+']').not(groupAllCheckbox);
        // is this the master your changing?
        if ($(this).is(groupAllCheckbox)) {
            if (groupAllCheckbox.prop('checked')) {
                otherCheckboxes.prop('checked', true);
            } else {
                otherCheckboxes.prop('checked', false);
            }
        } else {
            if (otherCheckboxes.filter(':checked').length === otherCheckboxes.length) {
                groupAllCheckbox.prop('checked', true);
            } else {
                groupAllCheckbox.prop('checked', false);
            }
        }
        table.draw();
    });
    $('#resetFilters').on('click', function() {
        $('form select').each(function(index) {
            $(this).val('');
        })
        $('#employeeTable_filter input').val('');
        $("input[type=radio][value='']").prop('checked', true);
        $("input[type=checkbox][customType='datatableFilter']").prop('checked', false);
        $('.collapse').collapse('hide');
        table.page.len(25).draw();
        table.order([0, 'asc']).draw();
        table.search('').draw();
        table.columns().search('');
        table.draw();
    });
    $('#export-all-btn').click(function () {
        handleExport("/employees/ajx_export_excel_all_employees");
    });
    $('#export-filtered-btn').click(function () {
        var searchParams = table.ajax.params();
        var queryString = $.param(searchParams);
        handleExport("/employees/ajx_export_excel_filtered_employees?" + queryString);
    });
    $('#import-new-employee-btn').click(function () {
        handleImport("/employees/ajx_import_insert_excel_employees_celery");  
    });
    $('#import-update-employee-btn').click(function () {
        handleImport("/employees/ajx_import_update_excel_employees_celery");    
    });
    function getCheckedValues(name) {
        var values = [];
        $('input[name="' + name + '"]:checked').each(function() {
            let val = $(this).val();
            if (name === 'chkEmployeeStatus' && val === 'ACTIVE') {
                values.push('PROBATION', 'REGULAR');
            }
            else {
                values.push(val);
            }
            return [...new Set(values)];  // Remove duplicates
        });
        return values;
    }
    function handleExport(url) {
        $.ajax({
            url: url,
            method: 'GET',
            beforeSend: function(xhr) {
                disableControls();
                $('#loader').show();
                $('#message').hide();
                $("#message").removeClass();
            },
            success: function (data) {
                $('#loader').hide();
                if (data.status === 'success') {
                    let downloadLink = document.getElementById('download-link');
                    downloadLink.href = '/media/' + data.filename; 
                    downloadLink.download = data.filename; 
                    downloadLink.click();
                    $("#message").addClass("alert alert-success");
                    $('#message').text('File generated and downloaded successfully.');
                    $('#message').show().delay(5000).slideUp(500);
                } else {
                    $("#message").addClass("alert alert-warning");
                    $('#message').text('An error occurred while generating the file.');
                    $('#message').show();
                }
            },
            error: function () {
                $('#loader').hide();
                $("#message").addClass("alert alert-warning");
                $('#message').text('An error occurred while generating the file.');
                $('#message').show();
            },
            complete: function() {
                enableControls();
            }
        });
    }
    function handleImport(url) {
        let fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.xlsx, .xls';
        fileInput.onchange = function(event) {
            let file = event.target.files[0];
            let formData = new FormData();
            formData.append('file', file);
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                beforeSend: function(xhr) {
                    disableControls();
                    $('#loader').show();
                    $('#message').hide();
                    $("#message").removeClass();
                },
                success: function(data) {
                    console.log(data);
                    $('#loader').hide();
                    if(data.status == 'error') {
                        $("#message").addClass("alert alert-warning");
                        $('#message').text(data.message);
                        $('#message').show();
                        enableControls();
                    }
                    else if (data.status == 'started') {
                        $('#loader').show();
                        $("#message").addClass("alert alert-info");
                        $('#message').text(data.message);
                        $('#message').show();
                        localStorage.setItem('importTaskId', data.task_id);
                        checkTaskStatus(data.task_id);
                    }
                    else if (data.status == 'testing') {
                        console.log('here 01')
                    }
                    else {
                        $("#message").addClass("alert alert-info");
                        $('#message').text(data.message);
                        $('#message').show().delay(5000).slideUp(500);
                        table.ajax.reload();
                        enableControls();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $('#loader').hide();
                    $('#message').show();
                    $("#message").addClass("alert alert-warning");
                    $('#message').text(errorThrown);
                    enableControls();
                    console.log(errorThrown);
                },
                complete: function() {}
            });
        };
        fileInput.click();
    }
    function disableControls() {
        $('#export-all-btn').prop('disabled', true);
        $('#export-filtered-btn').prop('disabled', true);
        $('#import-new-employee-btn').prop('disabled', true);
        $('#import-update-employee-btn').prop('disabled', true);
    }
    function enableControls() {
        $('#export-all-btn').prop('disabled', false);
        $('#export-filtered-btn').prop('disabled', false);
        $('#import-new-employee-btn').prop('disabled', false);
        $('#import-update-employee-btn').prop('disabled', false);
    }
    function checkTaskStatus(taskId) {
        $.get('/employees/ajx_tasks_status/' + taskId, function(data) {
            console.log('CTS03: ' + data.status);
            if (data.status == 'SUCCESS') {
                localStorage.removeItem('importTaskId');
                console.log('SUCCESS abcd');
                $('#loader').hide();
                $("#message").removeClass();
                $("#message").addClass("alert alert-success");
                $('#message').text('CTS03: Importing Successful.');
                $('#message').show().delay(5000).slideUp(500);
                table.ajax.reload();
                enableControls();
            } 
            else if (data.status == 'PENDING') {
                console.log('PENDING efg');
                setTimeout(function() {
                    checkTaskStatus(taskId);
                }, 2000);
            } 
            else if (data.status == 'FAILURE') {
                localStorage.removeItem('importTaskId');
                console.log('FAILURE HIJ');
                error_msg = data.message ?? '';
                $('#loader').hide();
                $("#message").removeClass();
                $("#message").addClass("alert alert-warning");
                $('#message').text('CTS01: Importing Fail. ' + error_msg);
                enableControls();
            }
            else if (data.status == 'ERROR') {
                // this else if should almost not happen as data.status will not return 'ERROR'
                localStorage.removeItem('importTaskId');
                console.log('ERROR KLM');
                $('#loader').hide();
                $("#message").removeClass();
                $("#message").addClass("alert alert-warning");
                $('#message').text('CTS02: ' + data.message);
                enableControls();
            }
        });
    }
});



# employees/templates/employees/employee_form.html
{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block title %}Create Employee{% endblock %}
{% block styles_bmain %}
{% endblock %}
{% block styles %}
{% endblock %}
{% block content %}
    &lt;div class="container-fluid"&gt;
    &lt;!-- Page Heading --&gt;
    &lt;div class="d-sm-flex align-items-center justify-content-between mb-4"&gt;
        &lt;h1 class="h3 mb-0 text-gray-800"&gt;Employee&lt;/h1&gt;
    &lt;/div&gt;
    &lt;!-- Content Row --&gt;
    &lt;div class="row"&gt;
        &lt;div class="col"&gt;
        &lt;div class="card shadow mb-4"&gt;
            &lt;div class="card-header py-3"&gt;
            &lt;h6 class="m-0 font-weight-bold text-primary"&gt;
                Employee - 
                {% if object %}
                Update
                {% else %}
                Add New
                {% endif %}              
            &lt;/h6&gt;
            &lt;/div&gt;
            &lt;div class="card-body"&gt;
            &lt;form method="POST"&gt;
                {% csrf_token %}
                {{ form | crispy }}
                &lt;div class="text-right"&gt;
                {% if object %}
                    &lt;button class="btn btn-primary" type="submit"&gt;Update Employee&lt;/button&gt;
                {% else %}
                    &lt;button class="btn btn-primary" type="submit"&gt;Add New Employee&lt;/button&gt;
                {% endif %}
                &lt;/div&gt;
            &lt;/form&gt;
            &lt;hr&gt;
            &lt;div class="text-right"&gt;
                &lt;a class="btn btn-info" href="{% url 'employees:employee-list' %}"&gt;Cancel&lt;/a&gt;
            &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;/div&gt;
{% endblock %}
{% block scripts_bmain %}
{% endblock %}
{% block scripts %}
    &lt;script src="{% static 'js/employee_form.js' %}"&gt;&lt;/script&gt;
{% endblock %}



# employees/templates/employees/employee_list.html
{% extends "base.html" %} 
{% load static %} 
{% block title %}Employee List{% endblock %} 
{% block styles_bmain %}
&lt;link href="https://cdn.datatables.net/v/bs5/dt-2.1.8/fc-5.0.4/fh-4.0.1/r-3.0.3/rg-1.5.1/rr-1.5.0/sc-2.4.3/datatables.min.css" rel="stylesheet"&gt;
{% endblock %} 
{% block styles %} 
{% endblock %} 
{% block content %}
&lt;!-- Begin Page Content --&gt;
&lt;div class="container-fluid"&gt;
    &lt;!-- Page Heading --&gt;
    &lt;div class="d-sm-flex align-items-center justify-content-between mb-4"&gt;
    &lt;h1 class="h3 mb-0 text-gray-800"&gt;Employees&lt;/h1&gt;
    &lt;/div&gt;
    &lt;!-- Content Row --&gt;
    &lt;div class="row"&gt;
    &lt;div class="col"&gt;
        &lt;div class="card shadow mb-4"&gt;
        &lt;div class="card-header py-3"&gt;
            &lt;h6 class="m-0 font-weight-bold text-primary"&gt;Employee - List&lt;/h6&gt;
        &lt;/div&gt;
        &lt;div class="card-body"&gt;
            &lt;div&gt;
            &lt;form&gt;
                &lt;div id="accordionDatatableFilter" class="mb-3"&gt;
                    &lt;div class="row accordion"&gt;
                    &lt;!-- filter position --&gt;
                    &lt;div class="card col-md"&gt;
                        &lt;div
                        class="card-header accordion-button collapsed"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseDF1"
                        &gt;
                        &lt;h5 class="mb-0"&gt;
                            &lt;button type="button" class="btn"&gt;
                            filter Position:
                            &lt;/button&gt;
                        &lt;/h5&gt;
                        &lt;/div&gt;
                        &lt;div id="collapseDF1" class="collapse"&gt;
                        &lt;div class="card-body"&gt;
                            &lt;input
                            type="checkbox"
                            name="chkPosition"
                            id="chkPosition-0"
                            value=""
                            class="btn-check"
                            customType="datatableFilter"
                            /&gt;
                            &lt;label class="btn btn-sm" for="chkPosition-0"
                            &gt;ALL&lt;/label
                            &gt;
                            {% for position in positions %}
                            &lt;input
                            type="checkbox"
                            name="chkPosition"
                            id="chkPosition-{{ forloop.counter }}"
                            value="{{ position.name }}"
                            class="btn-check"
                            customType="datatableFilter"
                            /&gt;
                            &lt;label
                            class="btn btn-sm"
                            for="chkPosition-{{ forloop.counter }}"
                            &gt;{{ position.name }}&lt;/label
                            &gt;
                            {% endfor %}
                        &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;!-- filter specialties --&gt;
                    &lt;div class="card col-md"&gt;
                        &lt;div
                        class="card-header accordion-button collapsed"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseDF2"
                        &gt;
                        &lt;h5 class="mb-0"&gt;
                            &lt;button type="button" class="btn"&gt;
                            filter Specialty:
                            &lt;/button&gt;
                        &lt;/h5&gt;
                        &lt;/div&gt;
                        &lt;div id="collapseDF2" class="collapse"&gt;
                        &lt;div class="card-body"&gt;
                            &lt;input
                            type="checkbox"
                            name="chkSpecialty"
                            id="chkSpecialty-0"
                            value=""
                            class="btn-check"
                            customType="datatableFilter"
                            /&gt;
                            &lt;label class="btn btn-sm" for="chkSpecialty-0"
                            &gt;ALL&lt;/label
                            &gt;
                            {% for specialty in specialties %}
                            &lt;input
                            type="checkbox"
                            name="chkSpecialty"
                            id="chkSpecialty-{{ forloop.counter }}"
                            value="{{ specialty.name }}"
                            class="btn-check"
                            customType="datatableFilter"
                            /&gt;
                            &lt;label
                            class="btn btn-sm"
                            for="chkSpecialty-{{ forloop.counter }}"
                            &gt;{{ specialty.name }}&lt;/label
                            &gt;
                            {% endfor %}
                        &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class="row accordion"&gt;
                    &lt;!-- filter gender --&gt;
                    &lt;div class="card col-md"&gt;
                        &lt;div
                        class="card-header accordion-button collapsed"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseDF3"
                        &gt;
                        &lt;h5 class="mb-0"&gt;
                            &lt;button type="button" class="btn"&gt;
                            filter Gender:
                            &lt;/button&gt;
                        &lt;/h5&gt;
                        &lt;/div&gt;
                        &lt;div id="collapseDF3" class="collapse"&gt;
                        &lt;div class="card-body"&gt;
                            &lt;input
                            type="checkbox"
                            name="chkGender"
                            id="chkGender-0"
                            value=""
                            class="btn-check"
                            customType="datatableFilter"
                            /&gt;
                            &lt;label class="btn btn-sm" for="chkGender-0"
                            &gt;ALL&lt;/label
                            &gt;
                            {% for gender in genders %}
                            &lt;input
                            type="checkbox"
                            name="chkGender"
                            id="chkGender-{{ forloop.counter }}"
                            value="{{ gender }}"
                            class="btn-check"
                            customType="datatableFilter"
                            /&gt;
                            &lt;label
                            class="btn btn-sm"
                            for="chkGender-{{ forloop.counter }}"
                            &gt;{{ gender }}&lt;/label
                            &gt;
                            {% endfor %}
                        &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;!-- filter status --&gt;
                    &lt;div class="card col-md"&gt;
                        &lt;div
                        class="card-header  accordion-button collapsed"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseDF4"
                        &gt;
                        &lt;h5 class="mb-0"&gt;
                            &lt;button type="button" class="btn"&gt;
                            filter Employee Status:
                            &lt;/button&gt;
                        &lt;/h5&gt;
                        &lt;/div&gt;
                        &lt;div id="collapseDF4" class="collapse"&gt;
                        &lt;div class="card-body"&gt;
                            &lt;input
                            type="checkbox"
                            name="chkEmployeeStatus"
                            id="chkEmployeeStatus-0"
                            value=""
                            class="btn-check"
                            customType="datatableFilter"
                            /&gt;
                            &lt;label class="btn btn-sm" for="chkEmployeeStatus-0"&gt;ALL&lt;/label&gt;
                            &lt;input
                            type="checkbox"
                            name="chkEmployeeStatus"
                            id="chkEmployeeStatus-1"
                            value="ACTIVE"
                            class="btn-check"
                            customType="datatableFilter"
                            /&gt;
                            &lt;label class="btn btn-sm" for="chkEmployeeStatus-1"&gt;ACTIVE&lt;/label&gt;
                            {% for status in employee_status %}
                            &lt;input
                            type="checkbox"
                            name="chkEmployeeStatus"
                            id="chkEmployeeStatus-{{ forloop.counter|add:'1' }}"
                            value="{{ status.name }}"
                            class="btn-check"
                            customType="datatableFilter"
                            /&gt;
                            &lt;label
                            class="btn btn-sm"
                            for="chkEmployeeStatus-{{ forloop.counter|add:'1' }}"
                            &gt;{{ status.name }}&lt;/label&gt;
                            {% endfor %}
                        &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class="row"&gt;
                    &lt;div class="col"&gt;
                        &lt;div class="form-group"&gt;
                        &lt;br /&gt;
                        &lt;button type="button" class="btn btn-sm btn-info" id="resetFilters"&gt;
                            Reset Filters
                        &lt;/button&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/form&gt;
            &lt;/div&gt;
            &lt;div class="btn-controls"&gt;
            &lt;h5&gt;Export/Import Controls&lt;/h5&gt;
            &lt;div class="row"&gt;
                &lt;div class="col"&gt;
                &lt;script type="text/javascript"&gt;
                    const csrfToken = "{{ csrf_token }}";
                &lt;/script&gt;
                &lt;button id="export-all-btn" class="btn btn-sm btn-primary"&gt;
                    Export: All Employee Records
                &lt;/button&gt;
                &lt;button id="export-filtered-btn" class="btn btn-sm btn-primary"&gt;
                    Export: All Employee Records by Filter
                &lt;/button&gt;
                &lt;button id="import-new-employee-btn" class="btn btn-sm btn-primary"&gt;
                    Import Insert: New Employee Records
                &lt;/button&gt;
                &lt;button id="import-update-employee-btn" class="btn btn-sm btn-primary"&gt;
                    Import Update: Existing Records
                &lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="row"&gt;
                &lt;div class="col"&gt;
                &lt;div id="loader" style="display: none" class="alert alert-info" role="alert"&gt;
                    &lt;i class="fas fa-cog fa-spin"&gt;&lt;/i&gt;
                    processing...
                &lt;/div&gt;
                &lt;div id="message" style="display: none" class="alert alert-info"&gt;&lt;/div&gt;
                &lt;a id="download-link" style="display: none"&gt;&lt;/a&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;/div&gt; 
            &lt;div class="table-responsive"&gt;
            &lt;table id="employeeTable" class="table table-sm table-striped table-hover"&gt;
                &lt;thead&gt;
                &lt;tr&gt;
                    &lt;th&gt;Company ID&lt;/th&gt;
                    &lt;th&gt;Start Date&lt;/th&gt;
                    &lt;th&gt;Last Name&lt;/th&gt;
                    &lt;th&gt;First Name&lt;/th&gt;
                    &lt;th&gt;Middle Name&lt;/th&gt;
                    &lt;th&gt;Position&lt;/th&gt;
                    &lt;th&gt;Specialties&lt;/th&gt;
                    &lt;th&gt;Level&lt;/th&gt;
                    &lt;th&gt;Gender&lt;/th&gt;
                    &lt;th&gt;Status&lt;/th&gt;
                &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;&lt;/tbody&gt;
            &lt;/table&gt;
            &lt;/div&gt;
            &lt;div&gt;
            &lt;div class="row"&gt;
                &lt;div class="col"&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;!-- /.container-fluid --&gt;
{% endblock %} 
{% block scripts_bmain %}
&lt;script src="https://cdn.datatables.net/v/bs5/dt-2.1.8/fc-5.0.4/fh-4.0.1/r-3.0.3/rg-1.5.1/rr-1.5.0/sc-2.4.3/datatables.min.js"&gt;&lt;/script&gt;
{% endblock %} 
{% block scripts %}
&lt;script src="{% static 'js/employee_list.js' %}"&gt;&lt;/script&gt;
{% endblock %}



# employees/templates/employees/employee_detail.html
{% extends "base.html" %}
{% block title %}Employee Detail{% endblock %}
{% block content %}
    &lt;div class="container-fluid"&gt;
    &lt;!-- Page Heading --&gt;
    &lt;div class="d-sm-flex align-items-center justify-content-between mb-4"&gt;
        &lt;h1 class="h3 mb-0 text-gray-800"&gt;Employee&lt;/h1&gt;
    &lt;/div&gt;
    &lt;!-- Content Row --&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-xl-6 col-lg-7"&gt;
            &lt;div class="card shadow mb-4"&gt;
                &lt;div class="card-header py-3"&gt;
                    &lt;h6 class="m-0 font-weight-bold text-primary"&gt;Employee Details&lt;/h6&gt;
                &lt;/div&gt;
                &lt;div class="card-body"&gt;
                    &lt;table class="table table-hover table-bordered"&gt;
                    &lt;tr&gt;
                        &lt;th class="col-3" scope="row"&gt;Company ID:&lt;/th&gt;
                        &lt;td&gt;{{object.company_id}}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Email:&lt;/th&gt;
                        &lt;td&gt;{{ object.user.email }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Username:&lt;/th&gt;
                        &lt;td&gt;{{ object.user.username }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Last Name:&lt;/th&gt;
                        &lt;td&gt;{{ object.user.last_name }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;First Name:&lt;/th&gt;
                        &lt;td&gt;{{ object.user.first_name }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Middle Name:&lt;/th&gt;
                        &lt;td&gt;{{ object.middle_name }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Gender:&lt;/th&gt;
                        &lt;td&gt;{{ object.gender }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Contact:&lt;/th&gt;
                        &lt;td&gt;{{ object.contact }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Birth Date:&lt;/th&gt;
                        &lt;td&gt;{{ object.birth_date }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Address:&lt;/th&gt;
                        &lt;td&gt;{{ object.address }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Start Date:&lt;/th&gt;
                        &lt;td&gt;{{ object.start_date }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Status:&lt;/th&gt;
                        &lt;td&gt;{{ object.status }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Position:&lt;/th&gt;
                        &lt;td&gt;{{ object.position }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Position Level:&lt;/th&gt;
                        &lt;td&gt;{{ object.position_level }}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th scope="row"&gt;Specialties:&lt;/th&gt;
                        &lt;td&gt;
                        {% for specialty in object.position_specialties.all %}
                            {{ specialty.name }}
                            {% if not forloop.last %}, {% endif %}
                        {% endfor %}
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;/table&gt;
                    &lt;div class="text-right"&gt;
                    &lt;a class="btn btn-info" href="{% url 'employees:employee-update' object.pk %}"&gt;Edit Employee&lt;/a&gt; 
                    &lt;a class="btn btn-info" href="{% url 'employees:employee-list' %}"&gt;Employee List&lt;/a&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="col-xl-6 col-lg-5"&gt;
            &lt;div class="card shadow mb-4"&gt;
                &lt;div class="card-header py-3"&gt;
                    &lt;h6 class="m-0 font-weight-bold text-info"&gt;Future Section&lt;/h6&gt;
                &lt;/div&gt;
                &lt;div class="card-body"&gt;
                    &lt;p&gt;
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Similique omnis exercitationem adipisci eos modi, dignissimos aut expedita, mollitia delectus nam ut repellendus a? Modi, laboriosam deleniti placeat iure deserunt molestias.
                    &lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
{% endblock %}



# employees/templates/registration/login.html
{% extends "base_login.html" %}
{% load crispy_forms_tags %}
{% block title %}Login{% endblock %}
{% block content %}
    &lt;div class="text-center"&gt;
    &lt;h1 class="h4 text-gray-900 mb-4"&gt;Welcome Back!&lt;/h1&gt;
    &lt;/div&gt;
    &lt;form method="post"&gt;
    {% csrf_token %}
    {{ form | crispy }}
    &lt;hr&gt;
    &lt;button class="btn btn-primary btn-block" type="submit"&gt;Login&lt;/button&gt;
    &lt;/form&gt;
{% endblock %}



# employees/templates/registration/logged_out.html
{% extends "base.html" %}
{% block title %}Logged Out{% endblock %}
{% block content %}
    &lt;p&gt;You have been logged out. &lt;a href="{% url 'login' %}"&gt;Log in again?&lt;/a&gt;&lt;/p&gt;
{% endblock %}



# pages/views.py
...



# users/views.py
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.contrib.auth import update_session_auth_hash
from .forms import UserUpdateForm, PasswordChangingForm
from employees.models import Employee
@login_required
def profile(request):
    if request.method == 'POST':
        form = UserUpdateForm(request.POST, instance=request.user)
        if form.is_valid():
            form.save()
            messages.success(request, 'Your profile has been updated successfully.')
            return redirect('profile')
    else:
        form = UserUpdateForm(instance=request.user)
    # get some user details
    try:
        # employee = get_object_or_404(Employee, user=request.user)
        employee = Employee.objects.get(user=request.user)
    except Employee.DoesNotExist:
        employee = None
    context = {
        'form': form,
        'employee': employee,
        # 'groups': groups
    }
    return render(request, 'users/profile.html', context)
@login_required
def change_password(request):
    if request.method == 'POST':
        form = PasswordChangingForm(data=request.POST, user=request.user)
        if form.is_valid():
            user = form.save()
            update_session_auth_hash(request, user)  # Important!
            request.session['default_password_checked'] = request.user.check_password('welcome01')
            messages.success(request, 'Your password was successfully updated!')
            return redirect('profile')
        else:
            messages.error(request, 'Please correct the error below.')
    else:
        form = PasswordChangingForm(user=request.user)
    context = {
        'form': form,
    }
    return render(request, 'users/change_password.html', context)



# employees/views.py
import pandas as pd
import os
from django.shortcuts import render, redirect, reverse
from django.core.paginator import Paginator
from django.http import JsonResponse, HttpResponse, HttpResponseRedirect
from django.urls import reverse_lazy
from django.utils import timezone
from django.contrib import messages
from django.contrib.auth.mixins import LoginRequiredMixin
from django.contrib.auth.decorators import permission_required, login_required
from django.contrib.auth.models import Group, Permission, User
from django.contrib.postgres.aggregates import ArrayAgg
from django.db.models import Q, Count, F, Case, When, IntegerField, Value, Prefetch, TextField
from django.db.models.functions import Coalesce
from django.contrib.postgres.aggregates import StringAgg
from employees.models import Employee, EmployeeJobSpecialty, EmployeeJobLevel, EmployeeJob, EmployeeStatus
from employees.forms import EmployeeCreationForm, EmployeeUpdateForm, EmployeeExcelUploadForm
from employees.utils import insert_excel_employees, update_excel_employees, handle_uploaded_file
from employees.tasks import import_employees_task
from celery.result import AsyncResult
from django.views.generic import ListView, DetailView, CreateView, UpdateView, DeleteView, TemplateView
class EmployeeListView(LoginRequiredMixin, ListView):
    model = Employee
    template_name = 'employees/employee_list.html'
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['positions'] = EmployeeJob.objects.all()
        context['specialties'] = EmployeeJobSpecialty.objects.all()
        context['genders'] = ['MALE', 'FEMALE']
        context['employee_status'] = EmployeeStatus.objects.filter(name__in=['REGULAR', 'PROBATION', 'SEPARATED'])
        return context
class EmployeeCreateView(LoginRequiredMixin, CreateView):
    model = Employee
    form_class = EmployeeCreationForm
    template_name = 'employees/employee_form.html'
    success_url = reverse_lazy('employees:employee-list')
class EmployeeDetailView(LoginRequiredMixin, DetailView):
    model = Employee
    template_name = 'employees/employee_detail.html'
class EmployeeUpdateView(LoginRequiredMixin, UpdateView):
    model = Employee
    form_class = EmployeeUpdateForm
    template_name = 'employees/employee_form.html'
    success_url = reverse_lazy('employees:employee-list')
    def form_valid(self, form):
        #
        messages.success(self.request, 'Employee updated successfully.')
        return super().form_valid(form)
    def form_invalid(self, form):
        #
        messages.warning(self.request, 'Please check errors below')
        return super().form_invalid(form)
@login_required
def ajx_employee_list(request):
    draw = int(request.GET.get('draw', 1))
    start = int(request.GET.get('start', 0))
    length = int(request.GET.get('length', 10))
    search_value = request.GET.get('search[value]', '')
    position_filter = request.GET.getlist('position[]', [])
    specialty_filter = request.GET.getlist('specialty[]', [])
    gender_filter = request.GET.getlist('gender[]', [])
    employee_status_filter = request.GET.getlist('employee_status[]', [])
    #
    employees = Employee.objects.all()
    if search_value:
        employees = employees.filter(
            Q(company_id__icontains=search_value) |
            Q(user__last_name__icontains=search_value) |
            Q(user__first_name__icontains=search_value) |
            Q(middle_name__icontains=search_value) |
            Q(position__name__icontains=search_value) |
            Q(position_specialties__name__icontains=search_value) |
            Q(position_level__name__icontains=search_value) |
            Q(gender__icontains=search_value) |
            Q(status__name__icontains=search_value)
        ).distinct()
    if position_filter:
        employees = employees.filter(position__name__in=position_filter)
    if specialty_filter:
        employees = employees.filter(position_specialties__name__in=specialty_filter)
    if gender_filter:
        employees = employees.filter(gender__in=gender_filter)
    if employee_status_filter:
        employees = employees.filter(status__name__in=employee_status_filter)
    #
    employees = employees.filter(user__is_active=True, user__is_superuser=False)
    #
    employees = employees.annotate(
        specialties_agg=Coalesce(
            StringAgg('position_specialties__name', ', ', distinct=True),
            Value(''),
            output_field=TextField()
        )
    )
    # Handle ordering
    order_column_index = int(request.GET.get('order[0][column]', 0))
    order_direction = request.GET.get('order[0][dir]', 'asc')
    order_column = request.GET.get(f'columns[{order_column_index}][data]', 'id')
    if order_column == 'last_name':
        order_column = 'user__last_name'
        if order_direction == 'desc':
            employees = employees.order_by(F(order_column).desc(nulls_last=True))
        else:
            employees = employees.order_by(F(order_column).asc(nulls_last=True))
    elif order_column == 'specialties':
        order_column = 'specialties_agg'
        if order_direction == 'desc':
            employees = employees.order_by(F(order_column).desc(nulls_last=True))
        else:
            employees = employees.order_by(F(order_column).asc(nulls_last=True))
    elif order_column == 'first_name':
        order_column = 'user__first_name'
        if order_direction == 'desc':
            employees = employees.order_by(F(order_column).desc(nulls_last=True))
        else:
            employees = employees.order_by(F(order_column).asc(nulls_last=True))
    elif order_column == 'level':
        order_column = 'position_level'
        if order_direction == 'desc':
            employees = employees.order_by(F(order_column).desc(nulls_last=True))
        else:
            employees = employees.order_by(F(order_column).asc(nulls_last=True))
    else:
        if order_direction == 'desc':
            order_column = f'-{order_column}'
        employees = employees.order_by(order_column)
    #
    employees = employees.select_related('status', 'position', 'position_level', 'user')
    employees = employees.prefetch_related('position_specialties')
    paginator = Paginator(employees, length)
    total_records = paginator.count
    employees_page = paginator.get_page(start // length + 1)
    #
    data = []
    for emp in employees_page:
        specialties = ', '.join([specialty.name for specialty in emp.position_specialties.all()]) if emp.position_specialties else ''
        data.append({
            'company_id': f"<a href='/employees/{emp.id}/'>{emp.company_id}</a>",
            'start_date': emp.start_date,
            'last_name': emp.user.last_name,
            'first_name': emp.user.first_name,
            'middle_name': emp.middle_name,
            'position': emp.position.name if emp.position else '',
            'specialties': specialties,
            'level': emp.position_level.name if emp.position_level else '',
            'gender': emp.gender,
            'status': emp.status.name if emp.status else ''
        })
    response = {
        'draw': draw,
        'recordsTotal': total_records,
        'recordsFiltered': total_records,
        'data': data
    }
    return JsonResponse(response)
@login_required
def ajx_export_excel_all_employees(request):
    #
    employees = Employee.objects.all()
    #
    employees = employees.filter(user__is_active=True, user__is_superuser=False)
    #
    employees = employees.select_related('status', 'position', 'position_level', 'user')
    employees = employees.prefetch_related('position_specialties')
    # Data to be exported
    data = []
    for employee in employees:
        specialties = ', '.join([specialty.name for specialty in employee.position_specialties.all()]) if employee.position_specialties else ''
        data.append({
            'COMPANY ID': employee.company_id,
            'FIRST NAME': employee.user.first_name,
            'LAST NAME': employee.user.last_name,
            'MIDDLE NAME': employee.middle_name,
            'GENDER': employee.gender,
            'EMAIL': employee.user.email,
            'CONTACT': employee.contact,
            'ADDRESS': employee.address,
            'BIRTH DATE': employee.birth_date,
            'START DATE': employee.start_date,
            'STATUS': employee.status.name if employee.status else '',
            'POSITION': employee.position.name if employee.position else '',
            'POSITION LEVEL': employee.position_level.name if employee.position_level else '',
            'POSITION SPECIALTIES': specialties,
            'REGULAR DATE': employee.regular_date,
            'SEPARATION DATE': employee.separation_date if employee.separation_date else '',
        })
    # Create a Pandas DataFrame
    df = pd.DataFrame(data)
    # Generate the Excel file
    filename = f"employee_records_{timezone.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
    df.to_excel(os.path.join('media', filename), index=False)
    return JsonResponse({'filename': filename, 'status': 'success'})
@login_required
def ajx_export_excel_filtered_employees(request):
    #
    search_value = request.GET.get('search[value]', '')
    #
    position_filter = request.GET.getlist('position[]', [])
    specialty_filter = request.GET.getlist('specialty[]', [])
    gender_filter = request.GET.getlist('gender[]', [])
    employee_status_filter = request.GET.getlist('employee_status[]', [])
    # Initial query with select_related for reducing the number of queries
    employees = Employee.objects.select_related(
        'status', 'position', 'position_level', 'user'
    ).prefetch_related('position_specialties')
    # Apply search filtering
    if search_value:
        employees = employees.filter(
            Q(company_id__icontains=search_value) |
            Q(user__last_name__icontains=search_value) |
            Q(user__first_name__icontains=search_value) |
            Q(middle_name__icontains=search_value) |
            Q(position__name__icontains=search_value) |
            Q(position_specialties__name__icontains=search_value) |
            Q(position_level__name__icontains=search_value) |
            Q(gender__icontains=search_value) |
            Q(status__name__icontains=search_value)
        ).distinct()
    if position_filter:
        employees = employees.filter(position__name__in=position_filter)
    if specialty_filter:
        employees = employees.filter(position_specialties__name__in=specialty_filter)
    if gender_filter:
        employees = employees.filter(gender__in=gender_filter)
    if employee_status_filter:
        employees = employees.filter(status__name__in=employee_status_filter)
    #
    employees = employees.filter(user__is_active=True, user__is_superuser=False)
    #
    employees = employees.annotate(
        specialties_agg=Coalesce(
            StringAgg('position_specialties__name', ', ', distinct=True),
            Value(''),
            output_field=TextField()
        )
    )
    # Data to be exported
    data = []
    for employee in employees:
        specialties = ', '.join([specialty.name for specialty in employee.position_specialties.all()]) if employee.position_specialties else ''
        data.append({
            'COMPANY ID': employee.company_id,
            'FIRST NAME': employee.user.first_name,
            'LAST NAME': employee.user.last_name,
            'MIDDLE NAME': employee.middle_name,
            'GENDER': employee.gender,
            'EMAIL': employee.user.email,
            'CONTACT': employee.contact,
            'ADDRESS': employee.address,
            'BIRTH DATE': employee.birth_date,
            'START DATE': employee.start_date,
            'STATUS': employee.status.name if employee.status else '',
            'POSITION': employee.position.name if employee.position else '',
            'POSITION LEVEL': employee.position_level.name if employee.position_level else '',
            'POSITION SPECIALTIES': specialties,
            'REGULAR DATE': employee.regular_date,
            'SEPARATION DATE': employee.separation_date if employee.separation_date else '',
        })
    # Create a Pandas DataFrame
    df = pd.DataFrame(data)
    # Generate the Excel file
    filename = f"filtered_employee_records_{timezone.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
    df.to_excel(os.path.join('media', filename), index=False)
    return JsonResponse({'filename': filename, 'status': 'success'})
@login_required
def ajx_import_insert_excel_employees_celery(request):
    #
    if request.method == 'POST':
        form = EmployeeExcelUploadForm(request.POST, request.FILES)
        if form.is_valid():
            file = request.FILES['file']
            try:
                # upload the file first in our system so we can have a path
                file_path = handle_uploaded_file(file)
                # start import of data using celery
                # this returns a task.id even if import_employees_task def has only pass. This means that we don't need to return anything from this def because .delay still returns a task even if there's none. It also doesn't matter if we return True or False to the function that we're calling
                # return JsonResponse({'status': 'testing', 'message': f"task is {task} and task.id is {task.id}"})
                task = import_employees_task.delay(file_path, mode='INSERT')
                return JsonResponse({'status': 'started', 'task_id': task.id, 'message': f"Import Insert Process TaskID {task.id} started. Please wait..."})
            except FileNotFoundError:
                # mostly it goes here if media/uploads directory doesn't exist or handle_uploaded_file not able to upload the file correctly
                return JsonResponse({'status': 'error', 'message': f"EV31: {str(FileNotFoundError)}. Check file or directory location"})
            except Exception as e:
                return JsonResponse({'status': 'error', 'message': f"EV30: {type(e)} | {str(e)}"})
    return JsonResponse({'status': 'error', 'message': 'EV03: Invalid request method.'})
@login_required
def ajx_import_update_excel_employees_celery(request):
    #
    if request.method == 'POST':
        form = EmployeeExcelUploadForm(request.POST, request.FILES)
        if form.is_valid():
            file = request.FILES['file']
            try:
                file_path = handle_uploaded_file(file)
                task = import_employees_task.delay(file_path, mode='UPDATE')
                return JsonResponse({'status': 'started', 'task_id': task.id, 'message': f"Import Update Process TaskID {task.id} started. Please wait..."})
            except FileNotFoundError:
                return JsonResponse({'status': 'error', 'message': f"EV33: {str(FileNotFoundError)}. Check file or directory location"})
            except Exception as e:
                return JsonResponse({'status': 'error', 'message': f"EV32: {type(e)} | {str(e)}"})
    return JsonResponse({'status': 'error', 'message': 'EV06: Invalid request method.'})
@login_required
def ajx_tasks_status(request, task_id):
    # task.state might return PENDING, SUCCESS, or FAILURE
    # FAILURE triggers when function called by .delay raise an error
    task = AsyncResult(task_id)
    return JsonResponse({
        'status': task.state,
        'task_id': task_id,
        # task.result has value only when function called by .delay raise an error
        'message': str(task.result),
    })



# employees/admin.py
from django.contrib import admin
from employees.models import Employee, EmployeeJob, EmployeeJobLevel, EmployeeJobSpecialty, EmployeeStatus
class EmployeeAdmin(admin.ModelAdmin):
    list_display = ('user', 'start_date', 'regular_date', 'status')
    search_fields = ('user', )
admin.site.register(EmployeeStatus)
admin.site.register(EmployeeJobSpecialty)
admin.site.register(EmployeeJobLevel)
admin.site.register(EmployeeJob)
admin.site.register(Employee, EmployeeAdmin)



# employees/signals.py
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.contrib.auth.models import User
from employees.models import Employee
@receiver(post_save, sender=User)
def create_employee_for_superuser(sender, instance, created, **kwargs):
    # Check if the user is a superuser and has no associated Employee
    if created and instance.is_superuser and not hasattr(instance, 'employee'):
        # Generate a company ID or use a default logic
        generated_company_id = f"ADMIN-{instance.id:04d}"  # Example company ID
        # Create a default Employee instance linked to the superuser
        Employee.objects.create(
            user=instance,
            company_id=generated_company_id,
            contact="N/A",  # Default value for fields
            middle_name="",  # Default value for fields
            gender="MALE",  # Default gender (or make this configurable)
        )



# employees/tasks.py
import pandas as pd
from celery import shared_task
from celery.exceptions import SoftTimeLimitExceeded
from django.core.management.base import CommandError
from employees.utils import insert_excel_employees, update_excel_employees
@shared_task()
def import_employees_task(file_path, mode='INSERT'):
    # notes
    # returning pass, True, False, or nothing at all will still mark the task SUCCESS.
    # raise an Exception or CommandError here or inside called functions to force FAILURE on celery task
    # raise CommandError(f"Testing commanderror")
    df = pd.read_excel(file_path)
    if mode == 'INSERT':
        insert_excel_employees(df)
    elif mode == 'UPDATE':
        update_excel_employees(df)
    else:
        raise Exception("TE01: Mode expecting INSERT or UPDATE only.")



# core/core/celery.py
from __future__ import absolute_import, unicode_literals
import os
from celery import Celery
# set the default Django settings module for the 'celery' program.
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
app = Celery('core')
# Using a string here means the worker doesn't have to serialize
# the configuration object to child processes.
app.config_from_object('django.conf:settings', namespace='CELERY')
# Load task modules from all registered Django app configs.
app.autodiscover_tasks()



# core/core/static/js/main.js
window.addEventListener('DOMContentLoaded', () => {
    console.log('main.js ready');
});



# core/management_commands/management/commands/insert_seeds.py
from django.core.management import call_command
from django.core.management.base import BaseCommand, CommandError
class Command(BaseCommand):
    help = 'Run a series of management commands to insert new records.'
    def handle(self, *args, **kwargs):
        try:
            # List of commands to run with their respective arguments
            commands_to_run = [
                #
                ('seed_employees_employeestatus',
                    'seed_employees_employeestatus.xlsx'),
                #
                ('seed_employees_employeejoblevel',
                    'seed_employees_employeejoblevel.xlsx'),
                #
                ('seed_employees_employeejob',
                    'seed_employees_employeejob.xlsx'),
                #
                ('seed_employees_employeejobspecialty',
                    'seed_employees_employeejobspecialty.xlsx'),
                #
                ('seed_employees_employee',
                    'seed_employees_employee.xlsx'),
                # Add more commands as needed
            ]
            for command_name, filename in commands_to_run:
                self.stdout.write(self.style.NOTICE(
                    f"Running {command_name} with {filename}..."))
                call_command(command_name, filename)
                self.stdout.write(self.style.SUCCESS(
                    f"Successfully ran {command_name}"))
        except CommandError as e:
            self.stderr.write(self.style.ERROR(f"Error: {e}"))
        self.stdout.write(self.style.SUCCESS(
            'All commands have been successfully executed.'))



# core/management_commands/management/commands/seed_employees_employee.py
import pandas as pd
from django.core.management.base import BaseCommand, CommandError
from django.core.exceptions import ValidationError
from employees.utils import insert_excel_employees
class Command(BaseCommand):
    help = 'Insert new employees from a given XLSX file'
    def add_arguments(self, parser):
        parser.add_argument(
            'filename', type=str, help='The path to the XLSX file containing the employee data.')
    def handle(self, *args, **kwargs):
        filename = kwargs['filename']
        # Load the file into a DataFrame
        if filename.endswith('.csv'):
            # df = pd.read_csv(filename, engine='python',
            #                  encoding='latin-1', date_format='%Y-%m-%d')
            df = pd.read_csv(filename, engine='python')
        elif filename.endswith('.xlsx'):
            df = pd.read_excel(filename)
        else:
            raise CommandError("The file must be a XLSX format.")
        if insert_excel_employees(df):
            self.stdout.write(self.style.SUCCESS(
                'Successfully inserted new employees.'))
        else:
            raise CommandError("Command insert_excel_employees fail")



# core/management_commands/management/commands/seed_employees_employeejob.py
import pandas as pd
from django.core.management.base import BaseCommand, CommandError
from employees.models import EmployeeJob
from django.db import transaction
class Command(BaseCommand):
    help = 'Insert new employee job from a CSV or XLSX file.'
    def add_arguments(self, parser):
        parser.add_argument('filename', type=str, help='The CSV or XLSX file containing employee job to insert.')
    def handle(self, *args, **options):
        filename = options['filename']
        # Determine file type
        if filename.endswith('.csv'):
            df = pd.read_csv(filename)
        elif filename.endswith('.xlsx'):
            df = pd.read_excel(filename)
        else:
            raise CommandError('Unsupported file type. Please provide a CSV or XLSX file.')
        # Check if the required columns exist
        required_columns = ['NAME']
        if not all(col in df.columns for col in required_columns):
            missing_columns = [col for col in required_columns if col not in df.columns]
            raise CommandError(f"Missing required columns: {', '.join(missing_columns)}")
        # Clean up data
        df['NAME'] = df['NAME'].fillna('').str.strip().str.upper()
        employee_job = df['NAME'].dropna().unique()
        # Check for existing employee_job
        existing_employee_job = EmployeeJob.objects.filter(name__in=employee_job).values_list('name', flat=True)
        if existing_employee_job:
            self.stdout.write(self.style.WARNING('The following employee job already exist in the database:'))
            for job in existing_employee_job:
                self.stdout.write(f'- {job}')
            self.stdout.write(self.style.ERROR('Aborting operation due to existing records.'))
        else:
            # Insert new employee job in a transaction
            try:
                with transaction.atomic():
                    for _, row in df.iterrows():
                        name = row['NAME']
                        job = EmployeeJob.objects.create(
                            name=name
                        )
                    self.stdout.write(self.style.SUCCESS('New Employee job records have been successfully added to the database.'))
            except Exception as e:
                raise CommandError(f'Error inserting new employee job: {str(e)}')



# core/management_commands/management/commands/seed_employees_employeejoblevel.py
import pandas as pd
from django.core.management.base import BaseCommand, CommandError
from employees.models import EmployeeJobLevel
from django.db import transaction
class Command(BaseCommand):
    help = 'Insert new employee level from a CSV or XLSX file.'
    def add_arguments(self, parser):
        parser.add_argument('filename', type=str, help='The CSV or XLSX file containing employee level to insert.')
    def handle(self, *args, **options):
        filename = options['filename']
        # Determine file type
        if filename.endswith('.csv'):
            df = pd.read_csv(filename)
        elif filename.endswith('.xlsx'):
            df = pd.read_excel(filename)
        else:
            raise CommandError('Unsupported file type. Please provide a CSV or XLSX file.')
        # Check if the required columns exist
        required_columns = ['NAME']
        if not all(col in df.columns for col in required_columns):
            missing_columns = [col for col in required_columns if col not in df.columns]
            raise CommandError(f"Missing required columns: {', '.join(missing_columns)}")
        # Clean up data
        df['NAME'] = df['NAME'].fillna('').str.strip().str.upper()
        employee_level = df['NAME'].dropna().unique()
        # Check for existing employee_level
        existing_employee_level = EmployeeJobLevel.objects.filter(name__in=employee_level).values_list('name', flat=True)
        if existing_employee_level:
            self.stdout.write(self.style.WARNING('The following employee level already exist in the database:'))
            for level in existing_employee_level:
                self.stdout.write(f'- {level}')
            self.stdout.write(self.style.ERROR('Aborting operation due to existing records.'))
        else:
            # Insert new employee level in a transaction
            try:
                with transaction.atomic():
                    for _, row in df.iterrows():
                        name = row['NAME']
                        level = EmployeeJobLevel.objects.create(name=name)
                    self.stdout.write(self.style.SUCCESS('New Employee level records have been successfully added to the database.'))
            except Exception as e:
                raise CommandError(f'Error inserting new employee level: {str(e)}')



# core/management_commands/management/commands/seed_employees_employeejobspecialty.py
import pandas as pd
from django.core.management.base import BaseCommand, CommandError
from employees.models import EmployeeJobSpecialty
from django.db import transaction
class Command(BaseCommand):
    help = 'Insert new employee specialty from a CSV or XLSX file.'
    def add_arguments(self, parser):
        parser.add_argument('filename', type=str, help='The CSV or XLSX file containing employee specialty to insert.')
    def handle(self, *args, **options):
        filename = options['filename']
        # Determine file type
        if filename.endswith('.csv'):
            df = pd.read_csv(filename)
        elif filename.endswith('.xlsx'):
            df = pd.read_excel(filename)
        else:
            raise CommandError('Unsupported file type. Please provide a CSV or XLSX file.')
        # Check if the required columns exist
        required_columns = ['NAME']
        if not all(col in df.columns for col in required_columns):
            missing_columns = [col for col in required_columns if col not in df.columns]
            raise CommandError(f"Missing required columns: {', '.join(missing_columns)}")
        # Clean up data
        df['NAME'] = df['NAME'].fillna('').str.strip().str.upper()
        employee_specialty = df['NAME'].dropna().unique()
        # Check for existing employee_specialty
        existing_employee_specialty = EmployeeJobSpecialty.objects.filter(name__in=employee_specialty).values_list('name', flat=True)
        if existing_employee_specialty:
            self.stdout.write(self.style.WARNING('The following employee specialty already exist in the database:'))
            for specialty in existing_employee_specialty:
                self.stdout.write(f'- {specialty}')
            self.stdout.write(self.style.ERROR('Aborting operation due to existing records.'))
        else:
            # Insert new employee specialty in a transaction
            try:
                with transaction.atomic():
                    for _, row in df.iterrows():
                        name = row['NAME']
                        specialty = EmployeeJobSpecialty.objects.create(name=name)
                    self.stdout.write(self.style.SUCCESS('New Employee specialty records have been successfully added to the database.'))
            except Exception as e:
                raise CommandError(f'Error inserting new employee specialty: {str(e)}')



# core/management_commands/management/commands/seed_employees_employeestatus.py
import pandas as pd
from django.core.management.base import BaseCommand, CommandError
from employees.models import EmployeeStatus
from django.db import transaction
class Command(BaseCommand):
    help = 'Insert new employee status from a CSV or XLSX file.'
    def add_arguments(self, parser):
        parser.add_argument('filename', type=str, help='The CSV or XLSX file containing employee status to insert.')
    def handle(self, *args, **options):
        filename = options['filename']
        # Determine file type
        if filename.endswith('.csv'):
            df = pd.read_csv(filename)
        elif filename.endswith('.xlsx'):
            df = pd.read_excel(filename)
        else:
            raise CommandError('Unsupported file type. Please provide a CSV or XLSX file.')
        # Check if the required columns exist
        required_columns = ['NAME']
        if not all(col in df.columns for col in required_columns):
            missing_columns = [col for col in required_columns if col not in df.columns]
            raise CommandError(f"Missing required columns: {', '.join(missing_columns)}")
        # Clean up data
        df['NAME'] = df['NAME'].fillna('').str.strip().str.upper()
        employee_status = df['NAME'].dropna().unique()
        # Check for existing employee_status
        existing_employee_status = EmployeeStatus.objects.filter(name__in=employee_status).values_list('name', flat=True)
        if existing_employee_status:
            self.stdout.write(self.style.WARNING('The following employee status already exist in the database:'))
            for status in existing_employee_status:
                self.stdout.write(f'- {status}')
            self.stdout.write(self.style.ERROR('Aborting operation due to existing records.'))
        else:
            # Insert new employee status in a transaction
            try:
                with transaction.atomic():
                    for _, row in df.iterrows():
                        name = row['NAME']
                        status = EmployeeStatus.objects.create(name=name)
                    self.stdout.write(self.style.SUCCESS('New Employee Status records have been successfully added to the database.'))
            except Exception as e:
                raise CommandError(f'Error inserting new employee status: {str(e)}')
</p>