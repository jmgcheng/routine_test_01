<h6 class="card-title question">Django: Practice Query</h6>
<p class="card-text answer-pre">
    # create sample models. Blog(category), Author, Entry, Book
    from datetime import date
    from django.db import models
    class Blog(models.Model):
        name = models.CharField(max_length=100)
        price = models.DecimalField(max_digits=10, decimal_places=2)
        tagline = models.TextField()
        def __str__(self):
            return self.name
    class Author(models.Model):
        name = models.CharField(max_length=200)
        email = models.EmailField()
        def __str__(self):
            return self.name
    class Entry(models.Model):
        blog = models.ForeignKey(Blog, on_delete=models.CASCADE)
        headline = models.CharField(max_length=255)
        body_text = models.TextField()
        pub_date = models.DateField()
        mod_date = models.DateField(default=date.today)
        authors = models.ManyToManyField(Author)
        number_of_comments = models.IntegerField(default=0)
        number_of_pingbacks = models.IntegerField(default=0)
        rating = models.IntegerField(default=5)
        def __str__(self):
            return self.headline
    class Book(models.Model):
        title = models.CharField(max_length=200)
        author = models.ForeignKey(Author, on_delete=models.CASCADE)
    
    
    
    # create a django query for - insert a record in Blog
    from blogs.models import Blog
    b = Blog(name="Beatles Blog", tagline="All the latest Beatles news.")
    b.save()
    # or
    b = Blog.objects.create(name="Beatles Blog", tagline="All the latest Beatles news.")
    
    
    
    # create a django query for - update a record column in recently created Blog
    b.name = "new name"
    b.save()



    # create a django query for - update an Entry record Foreignkey Entry.blog value
    from blog.models import Blog, Entry
    entry = Entry.objects.get(pk=1)
    cheese_blog = Blog.objects.get(name="Cheddar Talk")
    entry.blog = cheese_blog
    entry.save()



    # create a django query for - add an author in Entry.authors ManytoManyField  
    from blog.models import Author
    joe = Author.objects.create(name="Joe")
    entry.authors.add(joe)
    
    

    # create a django query for - add several authors in Entry.authors ManytoManyField   
    john = Author.objects.create(name="John")
    paul = Author.objects.create(name="Paul")
    george = Author.objects.create(name="George")
    ringo = Author.objects.create(name="Ringo")
    entry.authors.add(john, paul, george, ringo)
    
    
    
    # create a django query for - select a record in Entry using pk
    # sample converted query
    #    SELECT 
    #        "entry"."id",
    #        "entry"."blog_id",
    #        "entry"."headline",
    #        "entry"."body_text",
    #        "entry"."pub_date",
    #        "entry"."mod_date",
    #        "entry"."number_of_comments",
    #        "entry"."number_of_pingbacks",
    #        "entry"."rating"
    #    FROM "entry"
    #    WHERE "entry"."id" = 1
    #    LIMIT 21
    from blog.models import Entry
    entry = Entry.objects.get(pk=1)



    # create a django query for - select Blog records using pk in 
    # sample converted query
    #    SELECT 
    #        "blog"."id",
    #        "blog"."name",
    #        "blog"."tagline"
    #    FROM "blog"
    #    WHERE "blog"."id" IN (1, 4, 7)
    Blog.objects.filter(pk__in=[1, 4, 7])



    # create a django query for - select a record in Entry using get
    Entry.objects.get(id=1)



    # create a django query for - select all Blog where Blog.name is "beatles blog" case insensitive 
    # sample converted query
    #    SELECT "blog"."id",
    #        "blog"."name",
    #        "blog"."tagline"
    #    FROM "blog"
    #    WHERE "blog"."name" LIKE 'beatles blog' ESCAPE '\'
    #    LIMIT 21
    Blog.objects.get(name__iexact="beatles blog")



    # create a django query for - select all Entry where Entry.headline contains a "Lennon" string
    # sample converted query
    #    SELECT "entry"."id",
    #        "entry"."blog_id",
    #        "entry"."headline",
    #        "entry"."body_text",
    #        "entry"."pub_date",
    #        "entry"."mod_date",
    #        "entry"."number_of_comments",
    #        "entry"."number_of_pingbacks",
    #        "entry"."rating"
    #    FROM "entry"
    #    WHERE "entry"."headline" LIKE '%Lennon%' ESCAPE '\'
    #    LIMIT 21
    Entry.objects.get(headline__contains="Lennon")


    
    # create a django query for - select all Entry records
    # sample converted query
    #    SELECT 
    #        "entry"."id",
    #        "entry"."blog_id",
    #        "entry"."headline",
    #        "entry"."body_text",
    #        "entry"."pub_date",
    #        "entry"."mod_date",
    #        "entry"."number_of_comments",
    #        "entry"."number_of_pingbacks",
    #        "entry"."rating"
    #    FROM "entry"
    entries = Entry.objects.all()



    # create a django query for - select all Entry records limit 5
    # sample converted query
    #    SELECT 
    #        "entry"."id",
    #        "entry"."blog_id",
    #        "entry"."headline",
    #        ...
    #    FROM "entry"
    #    LIMIT 5
    Entry.objects.all()[:5]
    


    # create a django query for - select all Entry records offset 5 limit 5 
    # get records of a model OFFSET 5 LIMIT 5
    # sample converted query
    #    SELECT 
    #        "entry"."id",
    #        "entry"."blog_id",
    #        "entry"."headline",
    #        ...
    #    FROM "entry"
    #    LIMIT 5
    #    OFFSET 5    
    Entry.objects.all()[5:10]


    
    # create a django query for - select all Entry records where Entry.pub_date is greater or equal to '2006-01-01'
    # sample converted query
    #    SELECT 
    #        "entry"."id",
    #        "entry"."blog_id",
    #        "entry"."headline",
    #        "entry"."body_text",
    #        "entry"."pub_date",
    #        ...
    #    FROM "entry"
    #    WHERE "entry"."pub_date" <= '2006-01-01'
    Entry.objects.filter(pub_date__lte="2006-01-01")



    # create a django query for - select all Entry records where Entry.pub_date is BETWEEN '2006-01-01' AND '2006-12-31'
    # sample converted query
    #    SELECT 
    #        "entry"."id",
    #        "entry"."blog_id",
    #        "entry"."headline",
    #        "entry"."body_text",
    #        "entry"."pub_date",
    #        ...
    #    FROM "entry"
    #    WHERE "entry"."pub_date" BETWEEN '2006-01-01' AND '2006-12-31'
    Entry.objects.filter(pub_date__year=2006)



    # create a django query for - using chain filter and exclude, select all Entry records where Entry.headline starts with "What", Entry.pub_date excludes '2025-03-12', Entry.pub_date is greater or equal to '2005-01-30'
    # sample converted query    	
    #    SELECT 
    #        "entry"."id",
    #        "entry"."blog_id",
    #        "entry"."headline",
    #        "entry"."body_text",
    #        "entry"."pub_date",
    #        "entry"."mod_date",
    #        "entry"."number_of_comments",
    #        "entry"."number_of_pingbacks",
    #        "entry"."rating"
    #    FROM "entry"
    #    WHERE ("entry"."headline" LIKE 'What%' ESCAPE '\' AND NOT ("entry"."pub_date" >= '2025-03-12') AND "entry"."pub_date" >= '2005-01-30')
    Entry.objects.filter(headline__startswith="What").exclude(
            pub_date__gte=datetime.date.today()
        ).filter(pub_date__gte=datetime.date(2005, 1, 30))
    # or
    q1 = Entry.objects.filter(headline__startswith="What")
    q1 = q1.exclude(pub_date__gte='2025-03-12')
    q1 = q1.filter(pub_date__gte='2005-01-30')
    


    # create a django query for - using Q(), select all Poll where Poll.question starts with "Who" and ( Poll.pub_date is date(2005, 5, 2) OR Poll.pub_date is date(2005, 5, 6) )
    # sample converted query
    #    SELECT 
    #        * 
    #    From polls 
    #    WHERE question 
    #        LIKE 'Who%'
    #        AND (pub_date = '2005-05-02' OR pub_date = '2005-05-06')
    Poll.objects.get(
        Q(question__startswith="Who"),
        Q(pub_date=date(2005, 5, 2)) | Q(pub_date=date(2005, 5, 6)),
    )



    # create a django query for - select all Entry where Blog.name is "Beatles Blog"
    # sample converted query
    #    SELECT 
    #        "entry"."id",
    #        "entry"."blog_id",
    #        "entry"."headline",
    #        "entry"."body_text",
    #        "entry"."pub_date",
    #        "entry"."mod_date",
    #        "entry"."number_of_comments",
    #        "entry"."number_of_pingbacks",
    #        "entry"."rating"
    #    FROM 
    #        "entry"
    #    INNER JOIN 
    #        "blog"
    #        ON ("entry"."blog_id" = "blog"."id")
    #    WHERE "blog"."name" = 'Beatles Blog'
    Entry.objects.filter(blog__name="Beatles Blog")
    


    # create a django query for - select all Blog where Entry.headline contains 'Lennon'
    # sample converted query
    #    SELECT 
    #        "blog"."id",
    #        "blog"."name",
    #        "blog"."tagline"
    #    FROM 
    #        "blog"
    #    INNER JOIN 
    #        "entry"
    #        ON ("blog"."id" = "entry"."blog_id")
    #    WHERE "entry"."headline" LIKE '%Lennon%' ESCAPE '\'
    Blog.objects.filter(entry__headline__contains="Lennon")



    # create a django query for - select all Blog where Entry.author.name is "Lennon"
    # sample converted query
    #    SELECT 
    #        "blog"."id",
    #        "blog"."name",
    #        "blog"."tagline"
    #    FROM 
    #        "blog"
    #    INNER JOIN "entry"
    #        ON ("blog"."id" = "entry"."blog_id")
    #    INNER JOIN "entry_authors"
    #        ON ("entry"."id" = "entry_authors"."entry_id")
    #    INNER JOIN "author"
    #        ON ("entry_authors"."author_id" = "author"."id")
    #    WHERE "author"."name" = 'Lennon'
    Blog.objects.filter(entry__authors__name="Lennon")




    # create a django query for 
    Blog.objects.filter(entry__authors__isnull=False, entry__authors__name__isnull=True)
    # sample converted query
        SELECT "blog"."id",
            "blog"."name",
            "blog"."tagline"
        FROM "blog"
        INNER JOIN "entry"
            ON ("blog"."id" = "entry"."blog_id")
        INNER JOIN "entry_authors"
            ON ("entry"."id" = "entry_authors"."entry_id")
        INNER JOIN "author"
            ON ("entry_authors"."author_id" = "author"."id")
        WHERE ("entry_authors"."author_id" IS NOT NULL AND "author"."name" IS NULL)




    # create a django query for     
    # Blog.objects.exclude(
        entry__in=Entry.objects.filter(
            headline__contains="Lennon",
            pub_date__year=2008,
        ),
    )
    # sample converted query
        SELECT "blog"."id",
            "blog"."name",
            "blog"."tagline"
        FROM "blog"
        WHERE NOT (EXISTS(SELECT 1 AS "a" FROM "entry" V1 WHERE (V1."id" IN (SELECT U0."id" FROM "entry" U0 WHERE (U0."headline" LIKE '%Lennon%' ESCAPE '\' AND U0."pub_date" BETWEEN '2008-01-01' AND '2008-12-31')) AND V1."blog_id" = ("blog"."id")) LIMIT 1))
    


    # create a django query for 
    # from django.db.models import F
    Entry.objects.filter(number_of_comments__gt=F("number_of_pingbacks"))
    # sample converted query
        SELECT "entry"."id",
            "entry"."blog_id",
            "entry"."headline",
            "entry"."body_text",
            "entry"."pub_date",
            "entry"."mod_date",
            "entry"."number_of_comments",
            "entry"."number_of_pingbacks",
            "entry"."rating"
        FROM "entry"
        WHERE "entry"."number_of_comments" > ("entry"."number_of_pingbacks")



    # create a django query for 
    # Entry.objects.filter(rating__lt=F("number_of_comments") + F("number_of_pingbacks"))
    # sample converted query
        SELECT "entry"."id",
            "entry"."blog_id",
            "entry"."headline",
            "entry"."body_text",
            "entry"."pub_date",
            "entry"."mod_date",
            "entry"."number_of_comments",
            "entry"."number_of_pingbacks",
            "entry"."rating"
        FROM "entry"
        WHERE "entry"."rating" < ("entry"."number_of_comments" + "entry"."number_of_pingbacks")    




    # create a django query for 
    # Entry.objects.filter(authors__name=F("blog__name"))
    # sample converted query
        SELECT "entry"."id",
            "entry"."blog_id",
            "entry"."headline",
            "entry"."body_text",
            "entry"."pub_date",
            "entry"."mod_date",
            "entry"."number_of_comments",
            "entry"."number_of_pingbacks",
            "entry"."rating"
        FROM "entry"
        INNER JOIN "blog"
            ON ("entry"."blog_id" = "blog"."id")
        INNER JOIN "entry_authors"
            ON ("entry"."id" = "entry_authors"."entry_id")
        INNER JOIN "author"
            ON ("entry_authors"."author_id" = "author"."id")
        WHERE "author"."name" = ("blog"."name")



    # create a django query for 
    # from django.db.models import Min
    Entry.objects.aggregate(first_published_year=Min("pub_date__year"))
    # sample converted query
        SELECT MIN(django_date_extract('year', "entry"."pub_date")) AS "first_published_year"
        FROM "entry"




    # create a django query for 
    from django.db.models import Count
    authors = Author.objects.annotate(book_count=Count('book'))
    # sample converted query
        SELECT 
            "author"."id",
            "author"."name",
            "author"."email",
            COUNT("book"."id") AS "book_count"
        FROM 
            "author"
        LEFT OUTER JOIN 
            "book"
            ON ("author"."id" = "book"."author_id")
        GROUP BY 
            "author"."id",
            "author"."name",
            "author"."email"




    # create a django query for 
    from django.db.models import Avg
    authors = Author.objects.annotate(avg_price=Avg('book__price'))
    # sample converted query
        SELECT "author"."id",
            "author"."name",
            "author"."email",
            (CAST(AVG("book"."price") AS NUMERIC)) AS "avg_price"
        FROM "author"
        LEFT OUTER JOIN "book"
            ON ("author"."id" = "book"."author_id")
        GROUP BY "author"."id",
                "author"."name",
                "author"."email"



    # create a django query for 
    authors = Author.objects.annotate(
        book_count=Count('book'),
        avg_price=Avg('book__price'),
        latest_book=Max('book__published_date')
    )
    # sample converted query
        SELECT "author"."id",
            "author"."name",
            "author"."email",
            COUNT("book"."id") AS "book_count",
            (CAST(AVG("book"."price") AS NUMERIC)) AS "avg_price",
            MAX("book"."published_date") AS "latest_book"
        FROM "author"
        LEFT OUTER JOIN "book"
            ON ("author"."id" = "book"."author_id")
        GROUP BY "author"."id",
                "author"."name",
                "author"."email"







    # create a django query for 
    # We want to get the price of the latest book for each author.
    from django.db.models import Subquery, OuterRef
    from django.db.models import F
    latest_book_price = Book.objects.filter(
        author=OuterRef('id')
    ).order_by('-published_date').values('price')[:1]
    authors = Author.objects.annotate(latest_book_price=Subquery(latest_book_price))
    # sample converted query
        SELECT "author"."id",
            "author"."name",
            "author"."email",
            (
                SELECT U0."price"
                FROM "book" U0
                WHERE U0."author_id" = ("author"."id")
                ORDER BY U0."published_date" DESC
                LIMIT 1
            ) AS "latest_book_price"
        FROM "author"




    # create a django query for 
    # we want to get the title of the first book each author wrote
    first_book_title = Book.objects.filter(
        author=OuterRef('id')
    ).order_by('published_date').values('title')[:1]
    authors = Author.objects.annotate(first_book=Subquery(first_book_title))
    # sample converted query
        SELECT "author"."id",
            "author"."name",
            "author"."email",
            (
                SELECT U0."title"
                FROM "book" U0
                WHERE U0."author_id" = ("author"."id")
                ORDER BY U0."published_date" ASC
                LIMIT 1
            ) AS "first_book"
        FROM "author"



    # create a django query for 
    # get both the title and price of the latest book.
    latest_book = Book.objects.filter(
        author=OuterRef('id')
    ).order_by('-published_date')
    authors = Author.objects.annotate(
        latest_book_title=Subquery(latest_book.values('title')[:1]),
        latest_book_price=Subquery(latest_book.values('price')[:1])
    )
    # sample converted query
        SELECT "author"."id",
            "author"."name",
            "author"."email",
            (
                SELECT U0."title"
                FROM "book" U0
                WHERE U0."author_id" = ("author"."id")
                ORDER BY U0."published_date" DESC
                LIMIT 1
            ) AS "latest_book_title",
            (
                SELECT U0."price"
                FROM "book" U0
                WHERE U0."author_id" = ("author"."id")
                ORDER BY U0."published_date" DESC
                LIMIT 1
            ) AS "latest_book_price"
        FROM "author"    






    # create a django query for 
    # from django.db.models import OuterRef, Subquery, Sum
    Entry.objects.values("pub_date__year").annotate(
         top_rating=Subquery(
             Entry.objects.filter(
                 pub_date__year=OuterRef("pub_date__year"),
             )
             .order_by("-rating")
             .values("rating")[:1]
         ),
         total_comments=Sum("number_of_comments"),
     )
    # sample converted query
        SELECT (
                SELECT U0."rating"
                FROM "entry" U0
                WHERE django_date_extract('year', U0."pub_date") = (django_date_extract('year', "entry"."pub_date"))
                ORDER BY U0."rating" DESC
                LIMIT 1
            ) AS "top_rating",
            SUM("entry"."number_of_comments") AS "total_comments",
            django_date_extract('year', "entry"."pub_date") AS "pub_date__year"
        FROM "entry"
        GROUP BY 1, 3    







    #



</p>